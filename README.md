# **Hosting your python application in Docker container locally or azure container**

The main.py code is mostly generated by chatGPT with the following question:
> write a python code that compares 2 images using ssim, threshold the differences and generates a json output giving out all the differences with their image location in json output. The input images should be taken as FAST API arguments, read as numpy buffer and read using opencv grayscale and output should return the json data streamed back. Finally host it using uvicorn in port 8040

Some test functions are added, variables changed for readability, hosting removed in code and so on.

References:
1. Dataquest: https://www.youtube.com/watch?v=vVhS3VI9tus
2. Soundcode: https://markheath.net/post/build-container-images-with-acr
3. Udemy course: https://www.udemy.com/course/azure-machine-learning-mlops-mg/

## **For using local Docker container and hosting only in azure container registry**

1. Build docker with current folder as root directory (Windows command prompt). The *compareapi* name can be anything or like shown later set in your environment variable and used too.\
`docker buildx build --platform linux/amd64 -t compareapi .`\
For linux:\
`docker build -t compareapi .`
2. Run docker locally\
`docker run -d  --name compareapi -p 80:80 compareapi `
3. If you want to check container state\
`docker exec -t -i compareapi /bin/bash`
4. Now we set  global variables for resource group.\
`set NAME="compareapi"`\
In linux you can set using export instead of set command
5. To check variable name if its set or not\
`echo %NAME%`\
In linux rather than variable in between 2 %%, it is $.  This notation must be followed throughout whenever using variables\
`echo $NAME`
6. Login to azure from your command line and follow on screen.\
`az login`
7. Create resource group.\
`az acr create --resource-group %NAME% --name %NAME% --sku Basic`
8. Copy and paste loginServer value from above JSON (or you could write a command by getting value from az acr credentials and storing tsv output in a variable for future use)\
`compareapi.azurecr.io`
9. Login Azure container registry\
`az acr login --resource-group %NAME% --name %NAME%`
10. Tag with docker\
`docker tag compareapi compareapi.azurecr.io/compareapi`
11. Push docker api\
`docker push compareapi.azurecr.io/compareapi`
12. To run container on azure, first login docker to azure\
`docker login azure`
13. Create an aci context with docker context create aci azure. Select the resource group to use with your context.
\
`docker context create aci azure`
14. Run docker context ls to view your contexts.\
`docker context ls`
15. Switch context with docker context use azure\
`docker context use azure`
16. Run the container\
`docker run --name dlapi -p 80:80 -m 1.5G compareapi.azurecr.io/compareapi`
17. Run docker ps to get the URL of the container. You should be able to visit the URL shown to use the API.\
`docker ps`
18. (Optional) All good! save your money. Stop container in docker\
`docker stop compareapi`
19. (Optional) Remove container\
`docker rm compareapi`
20. (Optional) Most important. Delete resource group
`az group delete --name %NAME% --no-wait`


## **For using azure container and hosting online without local resources (Recommended Option)**

1. Login\
`az login`

2. Set variable\
`set resourceGroup="comparedemo"`

3. Create resource group\
`az group create -n %resourceGroup% -l centralindia`

4. Set container registry name\
`set acrName="compareacr"`

5. Create container registry. --admin-enabled flag if you want to be able to retrieve login credentials\
`az acr create -g %resourceGroup% -n %acrName% --sku Basic --admin-enabled`

6. Build acr\
`az acr build -r %acrName% -f .\Dockerfile -t comparewebapp:acr .`

7. (Optional) List all images in our ACR\
`az acr repository list -n %acrName%`

8. (Optional) Show the tags for the comparewebapp repository\
`az acr repository show-tags -n %acrName% --repository comparewebapp`

9. (Optional) show details for the comparewebapp:acr image\
`az acr repository show -n %acrName% -t comparewebapp:acr`

10. (Optional) if you want to delete\
`az acr repository delete -n %acrName% -t comparewebapp:acr`

11. store password from below for further steps (you could also store this in a variable and use rather than copy paste. Much easier to do in linux compared to windows. For how to do this automation check this link: https://stackoverflow.com/a/48404829/19901788 ) \
`az acr credential show -n %acrName% --query "passwords[0].value"  -o tsv`\
example:ABCDEFFGH12345ABCDEDF This will be the output from previous screen for next --registry-password argument

12. Create container \
`az container create -n comparewebapp -g %resourceGroup% --image compareacr.azurecr.io/comparewebapp:acr --registry-username %acrName% --registry-password ABCDEFFGH12345ABCDEDF --dns-name-label comparewebapp --ports 80 --memory 4`


13. (OPTIONAL) Delete  container when done\
`az container delete -n comparewebapp -g %resourceGroup% -y`
